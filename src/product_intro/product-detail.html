<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Chi ti·∫øt s·∫£n ph·∫©m</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin-bottom: 20px;
        }

        .product-card {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            color: #ff5a1f;
        }

        .product-header {
            background: #D4A017;
            padding: 25px;
            text-align: center;
        }

        .product-header h1 {
            color: white;
            font-size: 28px;
            font-weight: bold;
        }

        header {
            background: #c67401;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1000;
        }

        .product-image {
            background: #F5F5DC;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px dashed #D4A017;
            margin: 30px;
            border-radius: 10px;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
            display: block;
        }

        .product-info {
            padding: 0 30px 30px 30px;
        }

        .info-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #FFFEF0;
            border-radius: 8px;
            border-left: 4px solid #D4A017;
        }

        .info-section h3 {
            color: #D4A017;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .info-content {
            color: #555;
            line-height: 1.8;
            white-space: pre-line;
        }

        .seller-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #FFFEF0;
            border-radius: 8px;
            border-left: 4px solid #D4A017;
        }

        .seller-section h3 {
            color: #D4A017;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .seller-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .seller-avatar {
            flex-shrink: 0;
        }

        .seller-details {
            flex-grow: 1;
        }

        .seller-details p {
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }

        .seller-name {
            font-size: 16px;
            color: #333;
        }

        .seller-button {
            background: #D4A017;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .seller-button:hover {
            background: #B8860B;
        }

        .loading {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
            font-size: 18px;
        }

        .price-box {
            background: #D4A017;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .price-box h3 {
            color: white;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .price {
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        .stock-info {
            color: white;
            font-size: 14px;
            margin-top: 10px;
        }

        .buy-button {
            width: 100%;
            background: #D4A017;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .buy-button:hover {
            background: #B8860B;
        }

        .buy-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px;
        }

        @media (max-width: 768px) {
            .product-header h1 {
                font-size: 22px;
            }
            
            .product-image {
                margin: 20px;
                height: 300px;
            }

            .seller-info {
                flex-direction: column;
                text-align: center;
            }

            .seller-avatar {
                margin: 0 auto;
            }
        }

        .codepen-button {
            font-family: monospace;
            font-weight: bolder;
            display: block;
            cursor: pointer;
            color: #000;
            margin: 0 auto;
            position: relative;
            text-decoration: none;
            font-weight: 600;
            border-radius: 6px;
            overflow: hidden;
            padding: 3px;
            width: 160px;
            isolation: isolate;
            transform: scale(0.85);
        }

        .codepen-button::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 420%;
            height: 120%;
            background: linear-gradient(115deg, #628fbc, hsl(0, 93%, 73%), #f032a7, #329af0, #f032a7);
            background-size: 25% 100%;
            animation: border-animation 0.75s linear infinite;
            animation-play-state: paused;
            translate: -5% 0%;
            transition: translate 0.25s ease-out;
        }

        .codepen-button:hover::before {
            animation-play-state: running;
            transition-duration: 0.75s;
            translate: 0% 0%;
        }

        @keyframes border-animation {
            to {
                transform: translateX(-25%);
            }
        }

        .codepen-button span {
            position: relative;
            display: block;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            background: #fff;
            border-radius: 3px;
            height: 100%;
        }

        .codepen-button .span {
            display: flex;
            flex-direction: row;
            justify-content: start;
            align-items: center;
            gap: 10px;
        }

        .codepen-button .p {
            margin: 0;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <a href="../main.html"><img src="../../data/img/logo.png" alt="Logo" height="40" onerror="this.style.display='none'" /></a>

            <a class="codepen-button" style="margin-left:1050px" href="../cart.html">
                <span class="span">
                    <p class="p">Gi·ªè H√†ng</p>
                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" fill="#000" class="cart">
                        <path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                    </svg>
                </span>
            </a>

            <a class="codepen-button" style="margin-left:0px;width: 130px;" href="../profile.html">
                <span class="span">
                    <p class="p">Profile</p>
                </span>
            </a>
        </div>
    </header>

    <div id="loadingScreen" class="loading">
        ƒêang t·∫£i th√¥ng tin s·∫£n ph·∫©m...
    </div>

    <div id="errorScreen" class="error-message" style="display: none;">
        Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!
    </div>

    <div class="product-card" id="productCard" style="display: none;">
        <div class="product-header">
            <h1 id="productName">T√™n s·∫£n ph·∫©m</h1>
        </div>

        <div class="product-image">
            <img id="productImage" src="" alt="Product">
        </div>

        <div class="product-info">
            <div class="info-section">
                <h3>üçÉüçÉüçÉ M√¥ t·∫£ s·∫£n ph·∫©m üçÉüçÉüçÉ</h3>
                <div class="info-content" id="productDescription">
                    ƒêang t·∫£i m√¥ t·∫£...
                </div>
            </div>

            <div class="seller-section" id="sellerSection">
                <h3>üë§ Th√¥ng tin ng∆∞·ªùi b√°n</h3>
                <div class="loading" id="sellerLoading">ƒêang t·∫£i th√¥ng tin ng∆∞·ªùi b√°n...</div>
                <div class="seller-info" id="sellerInfo" style="display: none;">
                    <div class="seller-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#D4A017" width="60" height="60">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    <div class="seller-details">
                        <p class="seller-name"><strong>T√™n c·ª≠a h√†ng:</strong> <span id="sellerName">...</span></p>
                        <p class="seller-email">üìß Email: <span id="sellerEmail">...</span></p>
                        <p class="seller-id">üÜî Seller ID: <span id="sellerId">...</span></p>
                        <p class="seller-joined">üìÖ Tham gia: <span id="sellerJoined">...</span></p>
                    </div>
                </div>
            </div>

            <div class="price-box">
                <h3>GI√Å B√ÅN</h3>
                <div class="price" id="productPrice">0‚Ç´</div>
                <div class="stock-info" id="stockInfo">C√≤n h√†ng: 0</div>
            </div>

            <button class="buy-button" id="addToCartBtn">ƒê·∫∂T H√ÄNG NGAY</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SUPABASE_URL = 'https://cfzctoqsrkprcjstoqmp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmemN0b3FzcmtwcmNqc3RvcW1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDk5NjMsImV4cCI6MjA3ODMyNTk2M30.6p6c5JCwYimAp5kOQYvJ94jdciyhGNjB08c4uFI9eLc';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // L·∫•y product ID t·ª´ URL
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            showError('Kh√¥ng t√¨m th·∫•y ID s·∫£n ph·∫©m trong URL');
        } else {
            loadProduct(productId);
        }

        async function loadProduct(id) {
            try {
                // Load th√¥ng tin s·∫£n ph·∫©m
                const { data: product, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error || !product) {
                    showError('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m');
                    return;
                }

                // Hi·ªÉn th·ªã th√¥ng tin s·∫£n ph·∫©m
                displayProduct(product);
                
                // Load th√¥ng tin ng∆∞·ªùi b√°n
                loadSellerInfo(product.seller_id);

            } catch (error) {
                console.error('L·ªói:', error);
                showError('C√≥ l·ªói x·∫£y ra khi t·∫£i s·∫£n ph·∫©m');
            }
        }

        function displayProduct(product) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('productCard').style.display = 'block';

            // C·∫≠p nh·∫≠t th√¥ng tin
            document.getElementById('pageTitle').textContent = product.name;
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productImage').src = product.image_url || '../data/img/placeholder.jpg';
            document.getElementById('productDescription').textContent = product.description || 'Kh√¥ng c√≥ m√¥ t·∫£';
            document.getElementById('productPrice').textContent = Number(product.price).toLocaleString('vi-VN') + '‚Ç´';
            document.getElementById('stockInfo').textContent = `C√≤n h√†ng: ${product.stock || 0}`;

            // V√¥ hi·ªáu h√≥a n√∫t n·∫øu h·∫øt h√†ng
            const btn = document.getElementById('addToCartBtn');
            if (product.stock <= 0) {
                btn.disabled = true;
                btn.textContent = 'H·∫æT H√ÄNG';
            }

            // G·∫Øn s·ª± ki·ªán cho n√∫t
            btn.onclick = () => addToCart(product.id, product.seller_id);
        }

        async function loadSellerInfo(sellerId) {
            try {
                const { data: seller, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', sellerId)
                    .single();

                if (error || !seller) {
                    document.getElementById('sellerLoading').textContent = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi b√°n';
                    return;
                }

                document.getElementById('sellerLoading').style.display = 'none';
                document.getElementById('sellerInfo').style.display = 'flex';
                
                document.getElementById('sellerName').textContent = seller.full_name || seller.email || 'Kh√¥ng c√≥ t√™n';
                document.getElementById('sellerEmail').textContent = seller.email || 'Kh√¥ng c√≥ email';
                document.getElementById('sellerId').textContent = seller.id;
                
                if (seller.created_at) {
                    const date = new Date(seller.created_at);
                    document.getElementById('sellerJoined').textContent = date.toLocaleDateString('vi-VN');
                }

            } catch (error) {
                console.error('L·ªói:', error);
                document.getElementById('sellerLoading').textContent = 'ƒê√£ x·∫£y ra l·ªói';
            }
        }

        async function addToCart(productId, sellerId) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√™m v√†o gi·ªè h√†ng!');
                    window.location.href = './sign-in.html';
                    return;
                }

                // Ki·ªÉm tra xem ƒë√£ c√≥ trong gi·ªè ch∆∞a
                const { data: existing, error: checkError } = await supabase
                    .from('cart_items')
                    .select('id, quantity')
                    .eq('user_id', user.id)
                    .eq('product_id', productId)
                    .maybeSingle();

                if (existing) {
                    // ƒê√£ c√≥ ‚Üí tƒÉng s·ªë l∆∞·ª£ng
                    const { error: updateError } = await supabase
                        .from('cart_items')
                        .update({ quantity: existing.quantity + 1 })
                        .eq('id', existing.id);

                    if (updateError) {
                        alert('C·∫≠p nh·∫≠t gi·ªè h√†ng th·∫•t b·∫°i!');
                    } else {
                        alert('ƒê√£ tƒÉng s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè!');
                    }
                } else {
                    // Ch∆∞a c√≥ ‚Üí th√™m m·ªõi
                    const { error: insertError } = await supabase
                        .from('cart_items')
                        .insert({
                            user_id: user.id,
                            product_id: productId,
                            quantity: 1,
                            seller_id: sellerId
                        });

                    if (insertError) {
                        console.error('Insert error:', insertError);
                        alert('Th√™m v√†o gi·ªè th·∫•t b·∫°i: ' + insertError.message);
                    } else {
                        alert('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng th√†nh c√¥ng!');
                    }
                }
            } catch (error) {
                console.error('L·ªói:', error);
                alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!');
            }
        }

        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').textContent = message;
            document.getElementById('errorScreen').style.display = 'block';
        }
    </script>
</body>
</html>