<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Giỏ Hàng</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f6f6f6; }
  header {
    background: #fff; padding: 10px 20px; display: flex; align-items: center;
    justify-content: space-between; border-bottom: 1px solid #ddd;
    position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
  }
  h1 { font-size: 24px; margin: 20px 20px 10px; padding-top: 60px; }
  .cart-container { max-width: 1200px; margin: auto; padding: 20px; padding-bottom: 120px; }
  .seller-group { background: #fff; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
  .seller-header {
    display: flex; align-items: center; gap: 12px; padding: 15px;
    background: #fafafa; border-bottom: 1px solid #eee; font-weight: bold;
  }
  .seller-header img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .cart-item {
    display: flex; align-items: center; padding: 15px; gap: 15px;
    border-bottom: 1px solid #f0f0f0; position: relative;
  }
  .cart-item:last-child { border-bottom: none; }
  .cart-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
  .cart-item h2 { font-size: 16px; margin: 0 0 8px 0; line-height: 1.4; }
  .price { color: #d4a017; font-weight: bold; }
  .qty-box {
    display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px;
    background:#f3f4f6; border-radius:6px; font-weight:600;
  }
  .qty-box button {
    background:transparent; border:1px solid #ccc; width:28px; height:28px;
    border-radius:4px; cursor:pointer; font-size:16px;
  }
  .actions button.remove {
    background:#ff4444; color:white; border:none; padding:8px 12px;
    border-radius:6px; cursor:pointer;
  }
  .checkout-bar {
    position:fixed; bottom:0; left:0; right:0; background:#fff;
    padding:15px 20px; box-shadow:0 -4px 20px rgba(0,0,0,0.1);
    display:flex; align-items:center; gap:15px; z-index:999;
    font-size:18px; font-weight:bold;
  }
  .bubbles {
    --c1: #212121; --c2: #d4a017; --size-letter: 28px;
    padding: 0.6em 1.6em; font-size: var(--size-letter);
    background:transparent; border: calc(var(--size-letter)/6) solid var(--c2);
    border-radius:0.3em; cursor:pointer; overflow:hidden; position:relative;
    transition:300ms;
  }
  .bubbles > .text { font-weight:700; color:var(--c2); position:relative; z-index:1; }
  .bubbles::before, .bubbles::after {
    content:""; width:150%; aspect-ratio:1/1; scale:0; transition:800ms;
    background:var(--c2); border-radius:50%; position:absolute; translate:-50% -50%;
  }
  .bubbles::before { top:0; left:0; }
  .bubbles::after { top:100%; left:100%; }
  .bubbles:hover > .text { color:white; }
  .bubbles:hover::before, .bubbles:hover::after { scale:1; }
  .bubbles:active { scale:0.95; }
</style>
</head>
<body>

<header>
  <a href="../src/main.html">
    <img src="../data/img/logo.png" alt="Logo" height="40" />
  </a>
</header>

<h1>Giỏ Hàng Của Bạn</h1>
<div class="cart-container"></div>

<!-- Thanh toán + Nút Xem đơn hàng -->
<div class="checkout-bar">
  <label style="display:flex;align-items:center;gap:8px;">
    <input type="checkbox" id="selectAll" checked> Chọn tất cả
  </label>
  <div style="flex-grow:1;text-align:right;color:#d4a017;" id="selectedTotal">0₫</div>
  
  <button class="bubbles" onclick="checkoutSelected()" style="margin-right:10px;">
    <span class="text">Thanh toán</span>
  </button>

  <button class="bubbles" onclick="location.href='../src/orderlist.html'" style="background:#28a745;border-color:#28a745;">
    <span class="text" style="color:white;">Xem đơn hàng</span>
  </button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const SUPABASE_URL = 'https://cfzctoqsrkprcjstoqmp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmemN0b3FzcmtwcmNqc3RvcW1wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDk5NjMsImV4cCI6MjA3ODMyNTk2M30.6p6c5JCwYimAp5kOQYvJ94jdciyhGNjB08c4uFI9eLc';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const DEFAULT_SHOP_AVATAR = 'https://cfzctoqsrkprcjstoqmp.supabase.co/storage/v1/object/public/Shio/shop.png';

async function getUserId() {
  const { data } = await supabase.auth.getSession();
  return data?.session?.user?.id || null;
}

async function loadCart() {
  const userId = await getUserId();
  if (!userId) {
    document.querySelector('.cart-container').innerHTML = '<p style="text-align:center;padding:80px;color:#999;font-size:18px;">Vui lòng đăng nhập</p>';
    return;
  }

  const { data: items, error } = await supabase
    .from('cart_items')
    .select('id, quantity, seller_id, product:product_id(id, name, price, image_url)')
    .eq('user_id', userId);

  if (error || !items || items.length === 0) {
    document.querySelector('.cart-container').innerHTML = '<p style="text-align:center;padding:80px;color:#999;font-size:18px;">Giỏ hàng trống</p>';
    return;
  }

  // Lấy tên shop
  const sellerIds = [...new Set(items.map(i => i.seller_id).filter(Boolean))];
  let sellerMap = {};
  if (sellerIds.length > 0) {
    const { data: sellers } = await supabase
      .from('profiles')
      .select('id, full_name')
      .in('id', sellerIds);
    sellers?.forEach(s => {
      sellerMap[s.id] = { full_name: s.full_name || 'Cửa hàng', avatar_url: DEFAULT_SHOP_AVATAR };
    });
  }

  // Nhóm theo seller
  const groups = {};
  items.forEach(item => {
    const sid = item.seller_id || 'unknown';
    if (!groups[sid]) groups[sid] = [];
    groups[sid].push(item);
  });

  const container = document.querySelector('.cart-container');
  container.innerHTML = '';

  Object.entries(groups).forEach(([sellerId, groupItems]) => {
    const seller = sellerMap[sellerId] || { full_name: 'Cửa hàng', avatar_url: DEFAULT_SHOP_AVATAR };

    const groupDiv = document.createElement('div');
    groupDiv.className = 'seller-group';
    groupDiv.innerHTML = `
      <div class="seller-header">
        <input type="checkbox" class="select-seller" data-seller-id="${sellerId}" checked>
        <img src="${seller.avatar_url}" alt="Shop">
        <strong>${seller.full_name}</strong>
      </div>
      <div class="items-list">
        ${groupItems.map(item => {
          const p = item.product;
          const price = parseFloat(p?.price || 0);
          const subtotal = price * item.quantity;
          return `
            <div class="cart-item">
              <input type="checkbox" class="item-check" data-item-id="${item.id}" data-seller-id="${sellerId}" checked>
              <img src="${p?.image_url || 'https://via.placeholder.com/80'}" alt="${p?.name}">
              <div style="flex:1">
                <h2>${p?.name || 'Sản phẩm'}</h2>
                <p class="price">${price.toLocaleString('vi-VN')}₫</p>
              </div>
              <div class="qty-box" data-item-id="${item.id}">
                <button class="decrease">−</button>
                <div class="qty-value">${item.quantity}</div>
                <button class="increase">+</button>
              </div>
              <div style="text-align:right;min-width:120px">
                <div class="price">${subtotal.toLocaleString('vi-VN')}₫</div>
              </div>
              <div class="actions">
                <button class="remove" data-id="${item.id}">Xóa</button>
              </div>
            </div>`;
        }).join('')}
      </div>
    `;
    container.appendChild(groupDiv);
  });

  attachEvents();
  updateTotalSelected();
}

// === CÁC HÀM HỖ TRỢ ===
function attachEvents() {
  document.getElementById('selectAll').onchange = function() {
    document.querySelectorAll('.item-check, .select-seller').forEach(cb => cb.checked = this.checked);
    updateTotalSelected();
  };

  document.querySelectorAll('.select-seller').forEach(cb => {
    cb.onchange = function() {
      const sid = this.dataset.sellerId;
      document.querySelectorAll(`.item-check[data-seller-id="${sid}"]`).forEach(ic => ic.checked = this.checked);
      updateTotalSelected();
      syncSelectAll();
    };
  });

  document.querySelectorAll('.item-check').forEach(cb => {
    cb.onchange = () => { updateTotalSelected(); syncSelectAll(); };
  });

  document.querySelectorAll('.qty-box').forEach(box => {
    const id = box.dataset.itemId;
    box.querySelector('.increase').onclick = () => changeQuantity(id, 1);
    box.querySelector('.decrease').onclick = () => changeQuantity(id, -1);
  });

  document.querySelectorAll('button.remove').forEach(btn => {
    btn.onclick = async () => {
      if (confirm('Xóa sản phẩm này?')) {
        await supabase.from('cart_items').delete().eq('id', btn.dataset.id);
        loadCart();
      }
    };
  });
}

function syncSelectAll() {
  const allChecked = [...document.querySelectorAll('.item-check')].every(cb => cb.checked);
  document.getElementById('selectAll').checked = allChecked;
}

async function updateTotalSelected() {
  let total = 0;
  document.querySelectorAll('.item-check:checked').forEach(cb => {
    const item = cb.closest('.cart-item');
    const txt = item.querySelector('.price:last-of-type')?.textContent || '0';
    total += parseFloat(txt.replace(/[^0-9]/g, '') || 0);
  });
  document.getElementById('selectedTotal').textContent = total.toLocaleString('vi-VN') + '₫';
}

async function changeQuantity(id, delta) {
  const { data } = await supabase.from('cart_items').select('quantity').eq('id', id).single();
  const newQty = (data?.quantity || 0) + delta;
  if (newQty <= 0) {
    if (confirm('Xóa sản phẩm?')) await supabase.from('cart_items').delete().eq('id', id);
  } else {
    await supabase.from('cart_items').update({ quantity: newQty }).eq('id', id);
  }
  loadCart();
}

// === THANH TOÁN + CHUYỂN LUÔN VÀO ĐƠN HÀNG ===
async function checkoutSelected() {
  const checked = [...document.querySelectorAll('.item-check:checked')];
  if (checked.length === 0) return alert('Vui lòng chọn ít nhất 1 sản phẩm!');

  const itemIds = checked.map(cb => cb.dataset.itemId);
  const { data: items } = await supabase
    .from('cart_items')
    .select('id, product_id, quantity, seller_id, product:product_id(price)')
    .in('id', itemIds);

  const bySeller = {};
  items.forEach(i => {
    const sid = i.seller_id;
    if (!bySeller[sid]) bySeller[sid] = [];
    bySeller[sid].push(i);
  });

  const createdOrderIds = []; // Lưu các order_id để chuyển trang

  try {
    for (const [sellerId, group] of Object.entries(bySeller)) {
      let total = 0;
      const orderItems = group.map(i => {
        const price = parseFloat(i.product.price || 0);
        total += price * i.quantity;
        return { product_id: i.product_id, quantity: i.quantity, price };
      });

      const { data: order } = await supabase
        .from('orders')
        .insert({ 
          buyer_id: await getUserId(), 
          seller_id: sellerId, 
          total_amount: total, 
          status: 'pending' 
        })
        .select('id')
        .single();

      await supabase.from('order_items').insert(orderItems.map(it => ({ ...it, order_id: order.id })));
      await supabase.from('cart_items').delete().in('id', group.map(g => g.id));

      createdOrderIds.push(order.id);
    }

    // Thành công → chuyển luôn sang trang đơn hàng
    if (createdOrderIds.length === 1) {
      // Chỉ 1 đơn → vào chi tiết đơn
      window.location.href = `../src/order.html?orderId=${createdOrderIds[0]}`;
    } else {
      // Nhiều đơn → vào danh sách đơn
      window.location.href = '../src/orderlist.html';
    }

  } catch (e) {
    console.error(e);
    alert('Lỗi thanh toán: ' + (e.message || 'Vui lòng thử lại'));
  }
}

document.addEventListener('DOMContentLoaded', loadCart);
window.checkoutSelected = checkoutSelected;
</script>
</body>
</html>